<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>celq playground</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/nord.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/shell/shell.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>

    <style>
        body { 
            font-family: sans-serif; 
            background: #0f1419; 
            color: #bfbdb6; 
            margin: 20px; 
        }
        .grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
            margin-top: 20px; 
        }
        .panel { 
            display: flex; 
            flex-direction: column; 
        }
        .panel-header { 
            padding: 8px; 
            background: #1f2430; 
            font-weight: bold; 
            font-size: 0.9em; 
            color: #59c2ff;
            border-bottom: 2px solid #39bae6;
        }
        .CodeMirror { 
            height: 250px; 
            border: 1px solid #232834;
            background: #0b0e14;
        }
        #run-btn { 
            padding: 10px 30px; 
            background: #39bae6; 
            border: none; 
            color: #0f1419; 
            font-weight: bold; 
            cursor: pointer; 
            border-radius: 4px;
            transition: background 0.2s;
        }
        #run-btn:hover:not(:disabled) {
            background: #59c2ff;
        }
        #run-btn:disabled { 
            background: #4d5566; 
            color: #8a8f98;
        }
        .controls { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            margin-bottom: 20px; 
        }
        h1 { 
            margin: 0; 
            font-size: 1.5rem; 
            color: #59c2ff; 
        }
        #status {
            color: #73b8ff;
            font-size: 0.9em;
        }
        .repo-link {
            font-size: 0.85em;
            color: #73b8ff;
            text-decoration: none;
            margin-left: 10px;
        }
        .repo-link:hover {
            color: #59c2ff;
            text-decoration: underline;
        }
        .footer {
            margin-top: 20px;
            text-align: center;
            font-size: 0.8em;
            color: #4d5566;
        }
        .footer a {
            color: #73b8ff;
            text-decoration: none;
        }
        .footer a:hover {
            color: #59c2ff;
            text-decoration: underline;
        }
    </style>

    <script type="module">
        import { WASI, File, OpenFile, PreopenDirectory } from "https://cdn.jsdelivr.net/npm/@bjorn3/browser_wasi_shim@0.3.0/dist/index.js";

        let editors = {};

        window.addEventListener('DOMContentLoaded', () => {
            // Box 1: CLI command (Bash)
            editors.cmd = CodeMirror.fromTextArea(document.getElementById('cmd-input'), {
                mode: 'shell', theme: 'nord', lineNumbers: true
            });
            editors.cmd.setValue('celq --from-file expr.cel');

            // Box 2: Stdin (JSON)
            editors.stdin = CodeMirror.fromTextArea(document.getElementById('stdin-input'), {
                mode: {name: 'javascript', json: true}, theme: 'nord', lineNumbers: true
            });
            editors.stdin.setValue(JSON.stringify({"a": 1, "b": [1, 2, 3]}, null, 2));

            // Box 3: Expression (CEL/Python Highlight)
            editors.expr = CodeMirror.fromTextArea(document.getElementById('expr-input'), {
                mode: 'python', theme: 'nord', lineNumbers: true
            });
            editors.expr.setValue('this.b.filter(x, x >= 2)');

            // Box 4: Output (Plain Text, Read Only)
            editors.output = CodeMirror.fromTextArea(document.getElementById('output'), {
                mode: 'text/plain', theme: 'nord', readOnly: true
            });

            document.getElementById('status').textContent = 'Ready';
            document.getElementById('run-btn').disabled = false;
        });

        async function runCelq() {
            const statusEl = document.getElementById('status');
            const runBtn = document.getElementById('run-btn');
            
            try {
                runBtn.disabled = true;
                statusEl.textContent = 'Running...';
                editors.output.setValue('');

                const cmdLine = editors.cmd.getValue().trim();
                const stdinText = editors.stdin.getValue();
                const exprText = editors.expr.getValue();

                // 1. Prepare Arguments (Stripping the leading 'celq' if present)
                let args = parseCommandLine(cmdLine);
                if (args[0] === 'celq') args.shift();

                // 2. Setup Filesystem
                const encoder = new TextEncoder();
                const stdinFile = new File(encoder.encode(stdinText));
                const stdoutFile = new File([]); 
                const stderrFile = new File([]);

                const rootDir = new PreopenDirectory(".", new Map([
                    ["expr.cel", new File(encoder.encode(exprText))]
                ]));

                // 3. Initialize WASI
                const wasi = new WASI(["celq", ...args], [], [
                    new OpenFile(stdinFile),
                    new OpenFile(stdoutFile),
                    new OpenFile(stderrFile),
                    new PreopenDirectory(".", [
                        ["expr.cel", new File(encoder.encode(exprText))]
                    ])
                ]);

                // 4. Fetch and Run
                const response = await fetch('celq.wasm');
                if (!response.ok) {
                    throw new Error(`Failed to fetch celq.wasm: ${response.status} ${response.statusText}`);
                }
                const wasmBytes = await response.arrayBuffer();
                console.log(`Loaded WASM file: ${wasmBytes.byteLength} bytes`);
                
                const { instance } = await WebAssembly.instantiate(wasmBytes, {
                    wasi_snapshot_preview1: wasi.wasiImport
                });

                // Debug: Log available exports
                console.log("Available WASM exports:", Object.keys(instance.exports));

                // Initialize WASI with the instance
                wasi.inst = instance;

                // Initialize WASI
                let exitCode = 0;
                try {
                    // Check which entry point exists and call it
                    if (typeof instance.exports._start === 'function') {
                        console.log("Calling _start directly");
                        instance.exports._start();
                    } else if (typeof instance.exports._initialize === 'function') {
                        console.log("Calling _initialize");
                        instance.exports._initialize();
                    } else {
                        throw new Error("WASM module has no _start or _initialize export");
                    }
                } catch (e) {
                    // Capture exit code if available
                    if (e && typeof e.code === 'number') {
                        exitCode = e.code;
                    }
                    console.log("Process exited:", e);
                }

                // 5. Decode Output
                const decoder = new TextDecoder();
                const stdoutText = decoder.decode(stdoutFile.data);
                const stderrText = decoder.decode(stderrFile.data);

                if (stderrText) {
                    editors.output.setValue(`--- STDERR ---\n${stderrText}\n--- STDOUT ---\n${stdoutText}`);
                } else {
                    editors.output.setValue(stdoutText || "(No output generated)");
                }
                
                statusEl.textContent = 'Done';
            } catch (err) {
                let errorMsg = `Execution Error: ${err.message}`;
                
                // Provide helpful context for common errors
                if (err.message.includes('Failed to fetch')) {
                    errorMsg += '\n\nMake sure celq.wasm is in the same directory as this HTML file.';
                } else if (err.message.includes('no _start')) {
                    errorMsg += '\n\nThe WASM module appears to be missing the standard entry point.\nCheck console for available exports.';
                }
                
                editors.output.setValue(errorMsg);
                statusEl.textContent = 'Error';
                console.error('Full error:', err);
            } finally {
                runBtn.disabled = false;
            }
        }

        function parseCommandLine(cmd) {
            return cmd.match(/(?:[^\s"']+|"[^"]*"|'[^']*')+/g).map(s => s.replace(/^['"]|['"]$/g, ''));
        }

        window.runCelq = runCelq;
    </script>
</head>
<body>
    <div class="controls">
        <h1>celq playground</h1>
        <a href="https://github.com/IvanIsCoding/celq/" class="repo-link" target="_blank">â†’ GitHub</a>
        <button id="run-btn" onclick="runCelq()" disabled>RUN</button>
        <span id="status">Loading WASM...</span>
    </div>

    <div class="grid">
        <div class="panel">
            <div class="panel-header">CLI Command (Bash)</div>
            <textarea id="cmd-input"></textarea>
        </div>

        <div class="panel">
            <div class="panel-header">Stdin (JSON)</div>
            <textarea id="stdin-input"></textarea>
        </div>

        <div class="panel">
            <div class="panel-header">expr.cel (File System)</div>
            <textarea id="expr-input"></textarea>
        </div>

        <div class="panel">
            <div class="panel-header">Output (stdout)</div>
            <textarea id="output"></textarea>
        </div>
    </div>

    <div class="footer">
        Powered by <a href="https://github.com/cel-rust/cel-rust" target="_blank">cel-rust</a> and <a href="https://github.com/bjorn3/browser_wasi_shim" target="_blank">browser_wasi_shim</a>
        <br> Theme: <a href="https://www.nordtheme.com/" target="_blank">Inspired by Nord</a>
    </div>
</body>
</html>